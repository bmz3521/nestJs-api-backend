name: Node.js CI/CD and Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  build_and_deploy:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - run: npm ci

    - run: echo "${{ secrets.ENV_PROD }}" > .env

    - run: npm run build

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: "/home/ubuntu/actions-runner-nestJs-backend/_work/nestJs-api-backend/nestJs-api-backend"

    - name: Restart app on EC2
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/actions-runner-nestJs-backend/_work/nestJs-api-backend/nestJs-api-backend
          npm install --production
          pm2 reload ecosystem.config.js --env production || pm2 start dist/main.js --name nestjs-api-backend
